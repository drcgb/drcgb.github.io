<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Searchable and Filterable Table</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        body, table, th, td, .dataTables_wrapper .dataTables_filter input, 
        .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_info {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.2;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: white;
            z-index: 1000;
            padding: 10px 0;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            margin-top: 0;
            transition: margin-top 0.3s ease;
        }

        .custom-search-container {
            width: 99%;
            text-align: left;
            margin-bottom: 5px;
            padding: 10px;
        }

        .custom-search-container input {
            width: 99%;
            text-align: left;
            padding: 10px;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .dataTables_wrapper .filter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 5px;
            width: 100%;
            padding: 10px;
        }

        .filter-group {
            display: flex;
            align-items: center;
        }

        .filter-group label {
            margin-right: 2px;
        }

        .filter-group select {
            min-width: 150px;
            max-width: 100%;
        }

        @media (max-width: 600px) {
            .filter-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-group {
                width: 100%;
            }
        }

        .filter-status-btn {
            margin-left: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .filter-status-btn.green {
            background-color: #28a745;
            color: white;
        }
        .filter-status-btn.red {
            background-color: red;
            color: white;
        }

        .filter-notice {
            margin-top: 5px;
            margin-bottom: 5px;
            font-style: italic;
            color: #000000;
            background-color: #ebb6fcd8;
            border: 1px solid #c953ff;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
        }

        table, th, td {
            padding: 0px;
            border-collapse: collapse;
            border: 1px solid black;
        }
        th {
            background-color: #f2f2f2;
            text-align: left;
            vertical-align: middle;
        }
        table.dataTable tbody tr:hover {
            background-color: #e0f7fa;
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .end-of-records td {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #333;
            background-color: #f2f2f2;
            border-top: 2px solid #ccc;
        }

        .dataTables_wrapper .dataTables_paginate {
            position: static;
            margin-top: auto;
            background-color: white;
            padding: 10px 0;
            text-align: center;
            box-shadow: 0px -2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="fixed-header">
        <div class="custom-search-container">
            <input type="text" id="customSearch" placeholder="ðŸ” Search abstracts...">
        </div>
        <div class="dataTables_wrapper">
            <div class="filter-container">
                <div class="filter-group">
                    <label for="methodFilter">Filter(Method):</label>
                    <select id="methodFilter"><option value="">All</option></select>
                </div>
                <div class="filter-group">
                    <label for="areaFilter">Filter(Areas):</label>
                    <select id="areaFilter"><option value="">All</option></select>
                </div>
                <button id="filterStatusBtn" class="filter-status-btn green">No filters active</button>
            </div>
            <div class="filter-notice" id="filterNotice"></div>
        </div>
    </div>

    <div class="content">
        <div class="table-container">
            <table id="abstractTable" class="display">
                <thead>
                    <tr><th>Preliminary Title and Abstract</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        let allRows = [];
        let dataTable;

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                console.log("Loading XLSX data...");
                const response = await fetch("Prelim_Hons_Thesis_Titles_and_Abstracts_2024_FinalX.xlsx");
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                allRows = XLSX.utils.sheet_to_json(sheet, { header: 1 }).slice(1);
                console.log("Data loaded:", allRows);  // Log the loaded data

                populateTable(allRows);
                populateMethodFilter(allRows);
                populateAreaFilter(allRows);
                initializeDataTable();
            } catch (err) {
                console.error('Error loading XLSX data:', err);
            }
        });

        function initializeDataTable() {
    console.log("Initializing DataTable...");

    dataTable = $('#abstractTable').DataTable({
        paging: false,
        searching: true,
        info: true,
        autoWidth: false,
        ordering: false,
        lengthMenu: [[5, 10, 25, -1], [5, 10, 25, `${allRows.length} (All)`]],
        language: {
            lengthMenu: 'Show up to _MENU_ records per page',
        },
        dom: '<"top"l>rt<"bottom"p><"clear">',
        drawCallback: function(settings) {
            const api = this.api();
            const rows = api.rows({ search: 'applied' }).data().length;

            // Remove existing "End of records" row
            $('#abstractTable tbody .end-of-records').remove();

            // Add "End of records" row at the end
            if (rows === 0 || rows > 0) {
                $('#abstractTable tbody').append('<tr class="end-of-records"><td style="text-align: center; font-weight: bold; padding: 10px;">End of records</td></tr>');
            }
        }
    });

    // Custom filter logic
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        const methodValue = $('#methodFilter').val().toLowerCase().trim();
        const areaValue = $('#areaFilter').val().toLowerCase().trim();

        const mainMethod = methodData[dataIndex] ? methodData[dataIndex].toLowerCase().trim() : ''; // Ensure safe access
        const researchAreasContent = researchAreasData[dataIndex] ? researchAreasData[dataIndex].toLowerCase().trim() : ''; // Ensure safe access

        const methodMatch = methodValue === '' || mainMethod === methodValue;
        const areaMatch = areaValue === '' || researchAreasContent.split('; ').includes(areaValue);

        return methodMatch && areaMatch;
    });

    // Initial filtering
    dataTable.draw();

    // Attach events
    $('#customSearch').on('input', function() {
        dataTable.search($(this).val()).draw(); // Use DataTables native search
        updateFilterStatus();
        updateFilterNotice();
    });

    $('#methodFilter').on('change', function() {
        dataTable.draw();
        updateFilterStatus();
        updateFilterNotice();
    });

    $('#areaFilter').on('change', function() {
        dataTable.draw();
        updateFilterStatus();
        updateFilterNotice();
    });

    $('#filterStatusBtn').on('click', function() {
    if ($(this).hasClass('red')) {
        // Clear all filter inputs
        $('#methodFilter').val('');
        $('#areaFilter').val('');
        $('#customSearch').val('');

        // Clear DataTables native search and redraw
        dataTable.search('').draw(); 

        // Update filter status and notice
        updateFilterStatus();
        updateFilterNotice();

        // Scroll the window to the top instantly
        setTimeout(function() {
            window.scrollTo(0, 0);
        }, 0);
    }
});

    console.log("DataTable initialized.");
}
        let methodData = []; // New array to store Main Method data
        let researchAreasData = []; // New array to store Research Areas data

        function populateTable(rows) {
            console.log("Populating table...");
            methodData = []; // Reset arrays before populating
            researchAreasData = [];

            const tbody = document.querySelector("#abstractTable tbody");
            tbody.innerHTML = rows.map(row => {
                const [abstractID, mainMethod = '', methodDetail = '', preliminaryTitle = '', preliminaryAbstract = '', ...researchAreas] = row;
                const titleWithID = `<strong>ID: </strong>${abstractID}&nbsp&nbsp <strong>|</strong>&nbsp&nbsp <strong class="method-section">Method:</strong> ${mainMethod}${methodDetail ? ` (${methodDetail})` : ''} &nbsp <br><br> <strong class="abstract-title">${preliminaryTitle}</strong>`;
                const methodAndAreas = `<strong class="areas-section">Areas:</strong> ${researchAreas.filter(Boolean).join('; ')}`;

                methodData.push(mainMethod.toLowerCase().trim()); // Ensure lowercase and trim before pushing
                researchAreasData.push(researchAreas.filter(Boolean).join('; ').toLowerCase().trim());

                return `<tr><td><br>${titleWithID}<br>${preliminaryAbstract}<br><br>${methodAndAreas}<br><br></td></tr>`;
            }).join('');

            tbody.innerHTML += `<tr class="end-of-records"><td><strong>End of records</strong></td></tr>`;
            console.log("Table populated.");
        }
          
        function populateMethodFilter(rows) {
            console.log("Populating method filter...");
            const methodCounts = {};
            rows.forEach(row => {
                const mainMethod = row[1]?.trim().toLowerCase();
                if (mainMethod) {
                    methodCounts[mainMethod] = (methodCounts[mainMethod] || 0) + 1;
                }
            });

            const methodFilter = document.getElementById("methodFilter");
            methodFilter.innerHTML += Object.entries(methodCounts).map(([method, count]) => {
                return `<option value="${method}">${method} [~${count} matches]</option>`;
            }).join('');
            console.log("Method filter populated.");
        }

        function populateAreaFilter(rows) {
            console.log("Populating area filter...");
            const areaCounts = {};
            rows.forEach(row => {
                const researchAreas = row.slice(5, 11).map(area => area?.trim().toLowerCase() || '');
                researchAreas.forEach(area => {
                    if (area) {
                        areaCounts[area] = (areaCounts[area] || 0) + 1;
                    }
                });
            });

            const areaFilter = document.getElementById("areaFilter");
            areaFilter.innerHTML += Object.entries(areaCounts).map(([area, count]) => {
                return `<option value="${area}">${area} [~${count} matches]</option>`;
            }).join('');
            console.log("Area filter populated.");
        }

        function updateFilterStatus() {
            const searchValue = $('#customSearch').val().trim();
            const methodValue = $('#methodFilter').val();
            const areaValue = $('#areaFilter').val();

            const filterActive = searchValue !== '' || methodValue !== '' || areaValue !== '';

            const button = $('#filterStatusBtn');
            if (filterActive) {
                button.removeClass('green').addClass('red').text('Click to clear all filters');
            } else {
                button.removeClass('red').addClass('green').text('No filters active');
            }
        }

        function updateFilterNotice() {
    const searchValue = $('#customSearch').val().trim();
    const methodValue = $('#methodFilter').val();
    const areaValue = $('#areaFilter').val();

    let activeFilters = [];
    if (searchValue) activeFilters.push(`Search: "${searchValue}"`);
    if (methodValue) activeFilters.push(`Method: "${methodValue}"`);
    if (areaValue) activeFilters.push(`Area: "${areaValue}"`);

    const notice = $('#filterNotice');
    const filteredRows = dataTable.rows({ filter: 'applied' }).data().toArray();

    // Exclude "End of records" row from the count
    const filteredRowCount = filteredRows.filter(row => !row[0].includes("End of records")).length;

    if (activeFilters.length > 0) {
        if (filteredRowCount > 0) {
             notice.html(`Active Filters: ${activeFilters.join(' <strong>+</strong> ')} | <strong>${filteredRowCount} record(s) found.</strong>`).show();
        } else {
            let alertMessage = '<strong>No results found with the current filter combination.</strong> ';
            alertMessage += 'Try adjusting the filters.';
            notice.html(alertMessage).show();
        }
}   else {
        notice.hide();
}
adjustContentMargin();
}
        function adjustContentMargin() {
            const filterNoticeHeight = $('#filterNotice').is(':visible') ? $('#filterNotice').outerHeight(true) : 0;
            const headerHeight = $('.fixed-header').outerHeight(true);
            const totalMargin = headerHeight + (filterNoticeHeight > 0 ? filterNoticeHeight - 40 : 0);

            $('.content').css('margin-top', totalMargin);
        }

      // (Include your script setup, variable declarations, etc. here)

// Add event listeners only once, at the end of your script

$(document).ready(function() {
    adjustContentMargin();

    $('#customSearch').on('input', function() {
        dataTable.search($(this).val()).draw(); // Use native DataTables search
        updateFilterStatus();
        updateFilterNotice();
        window.scrollTo(0, 0); // Scroll to the top when a search is performed
    });

    $('#methodFilter').on('change', function() {
        dataTable.draw();
        updateFilterStatus();
        updateFilterNotice();
        window.scrollTo(0, 0); // Scroll to the top when a filter is applied
    });

    $('#areaFilter').on('change', function() {
        dataTable.draw();
        updateFilterStatus();
        updateFilterNotice();
        window.scrollTo(0, 0); // Scroll to the top when a filter is applied
    });

    $('#filterStatusBtn').on('click', function() {
        if ($(this).hasClass('red')) {
            // Clear all filter inputs
            $('#methodFilter').val('');      // Clear the method filter dropdown
            $('#areaFilter').val('');        // Clear the area filter dropdown
            $('#customSearch').val('');      // Clear the custom search input field

            // Clear DataTables native search and redraw
            dataTable.search('').draw();     // Clear native DataTables search

            // Update filter status and notice
            updateFilterStatus();
            updateFilterNotice();

            // Scroll the window to the top instantly
            window.scrollTo(0, 0);
        }
    });
});

// Continue with the rest of your script

</script>
</body>
</html>