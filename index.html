<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Searchable and Filterable Table</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <style>
        body, table, th, td, .clear-filters, .filter-notice, .dataTables_wrapper .dataTables_filter input, 
        .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_info {
            font-family: Arial, sans-serif; font-size: 14px; line-height: 1.2;
        }
        .dataTables_wrapper .dataTables_filter {
            text-align: left;
            width: 100%;
            margin-bottom: 10px;
        }
        .dataTables_wrapper .dataTables_filter input {
            width: 100%; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 16px;
        }
        .filter-container {
            display: flex; flex-wrap: wrap; align-items: center;
            margin-bottom: 10px;
        }
        .filter-container label, .filter-container select {
            font-size: 14px; margin-right: 10px; padding-right: 10px;
        }
        .dataTables_wrapper .dataTables_length {
            float: right;
        }
        .dataTables_wrapper .dataTables_paginate {
            text-align: center;
        }
        table, th, td {
            padding: 0px; border-collapse: collapse; border: 1px solid black;
        }
        th {
            background-color: #f2f2f2; text-align: left; vertical-align: middle; pointer-events: none;
        }
        table.dataTable tbody tr:hover {
            background-color: #e0f7fa;
        }
        .clear-filters {
            cursor: pointer; background-color: #28a745; color: white; border: none; padding: 8px 12px;
            border-radius: 5px; transition: background-color 0.3s, color 0.3s;
        }
        .clear-filters.active {
            background-color: red;
        }
        .filter-notice {
            margin: 10px 0; font-style: italic; color: #555;
        }
    </style>
</head>
<body>

<div class="dataTables_wrapper">
    <div id="abstractTable_filter" class="dataTables_filter"></div>

    <div class="filter-container">
        <label for="areaFilter">Filter(Area):</label>
        <select id="areaFilter"><option value="">All</option></select>
        <label for="methodFilter">Filter(Method):</label>
        <select id="methodFilter"><option value="">All</option></select>
        <button class="clear-filters" id="clearFiltersBtn">No filters selected</button>
    </div>

    <table id="abstractTable" class="display">
        <thead>
            <tr><th>Preliminary Title and Abstract</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="filter-notice" id="filterNotice" style="display: none;"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    let allRows = [];
    let dataTable;

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const response = await fetch("Prelim_Hons_Thesis_Titles_and_Abstracts_2024_FinalX.xlsx");
            const data = await response.arrayBuffer();
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            allRows = XLSX.utils.sheet_to_json(sheet, { header: 1 }).slice(1);
            populateTable(allRows);
            populateFilterOptions(allRows);
            initializeDataTable();
        } catch (err) {
            console.error('Error loading XLSX data:', err);
        }
    });

    function initializeDataTable() {
        dataTable = $('#abstractTable').DataTable({
            paging: true,
            searching: true,
            info: true,
            autoWidth: false,
            ordering: false,
            lengthMenu: [[15, 30, 60, -1], [15, 30, 60, `${allRows.length} (All)`]],
            language: {
                lengthMenu: 'Show up to _MENU_ records per page',
                search: '',
                searchPlaceholder: '🔍Search abstracts...'
            },
            columns: [{ title: "Preliminary Title and Abstract" }]
        });

        // Ensure the search bar is at the top
        $('#abstractTable_filter').detach().prependTo('.dataTables_wrapper');
    }

    function populateTable(rows) {
        const tbody = document.querySelector("#abstractTable tbody");
        tbody.innerHTML = rows.map(row => {
            const [abstractID, mainMethod = '', methodDetail = '', preliminaryTitle = '', preliminaryAbstract = '', ...researchAreas] = row;
            const titleWithID = `<strong>ID: </strong>${abstractID}&nbsp&nbsp <strong>|</strong>&nbsp&nbsp <strong class="method-section">Method:</strong> ${mainMethod}${methodDetail ? ` (${methodDetail})` : ''} &nbsp <br><br> <strong class="abstract-title">${preliminaryTitle}</strong>`;
            const methodAndAreas = `<strong class="areas-section">Areas:</strong> ${researchAreas.filter(Boolean).join('; ')}`;
            return `<tr><td><br>${titleWithID}<br>${preliminaryAbstract}<br><br>${methodAndAreas}<br><br></td></tr>`;
        }).join('');
        
        if (dataTable) {
            dataTable.clear().draw();
            dataTable.rows.add($(tbody).children()).draw();
        }
    }

    function populateFilterOptions(rows) {
        const methodCounts = {}, areaCounts = {};
        rows.forEach(row => {
            const [_, mainMethod = '', , , , ...researchAreas] = row;
            methodCounts[mainMethod] = (methodCounts[mainMethod] || 0) + 1;
            researchAreas.forEach(area => area && (areaCounts[area] = (areaCounts[area] || 0) + 1));
        });
        document.getElementById("methodFilter").innerHTML += generateOptions(methodCounts, (a, b) => b[1] - a[1]);
        document.getElementById("areaFilter").innerHTML += generateOptions(areaCounts, ([a], [b]) => a.localeCompare(b));
    }

    function generateOptions(counts, sortFn) {
        return Object.entries(counts).sort(sortFn).map(([key, count]) => `<option value="${key}">${key} [${count} matches]</option>`).join('');
    }

    function filterTable() {
        const methodFilter = document.getElementById("methodFilter").value.toLowerCase();
        const areaFilter = document.getElementById("areaFilter").value.toLowerCase();

        const filteredRows = allRows.filter(row => {
            const mainMethod = row[1]?.toLowerCase() || '';
            const researchAreas = row.slice(5, 11).map(area => area?.toLowerCase() || '');

            return (!methodFilter || mainMethod.includes(methodFilter)) && 
                   (!areaFilter || researchAreas.some(area => area.includes(areaFilter)));
        });

        populateTable(filteredRows);
    }

    document.getElementById("methodFilter").addEventListener("change", function() {
        filterTable();
        dataTable.draw();
    });

    document.getElementById("areaFilter").addEventListener("change", function() {
        filterTable();
        dataTable.draw();
    });

    document.getElementById("clearFiltersBtn").addEventListener("click", function() {
        document.getElementById("methodFilter").selectedIndex = 0;
        document.getElementById("areaFilter").selectedIndex = 0;
        filterTable();
        dataTable.search('').draw(); // Clear the search as well
    });
</script>
</body>
</html>