<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Searchable and Filterable Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            white-space: normal;
            text-align: center;
        }
        th:nth-child(3), td:nth-child(3) {
            width: 35%;
        }
        th:not(:nth-child(3)), td:not(:nth-child(3)) {
            width: 13%;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
        }
        #searchInput {
            width: 87%; /* Adjusted to align with the last column */
        }
        .filter-container {
            margin-top: 10px;
            display: flex;
            align-items: center;
        }
        .filter-notice {
            margin-top: 10px;
            margin-bottom: 10px;
            font-style: italic;
            color: #555;
        }
        .clear-filters {
            margin-left: 20px;
            cursor: pointer;
            background-color: #28a745; /* Default to green when no filters */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .clear-filters.active {
            background-color: #007bff; /* Blue when filters are active */
        }
    </style>
</head>
<body>

<div class="search-container">
    <label for="searchInput"><strong>Search:</strong></label>
    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search abstracts...">
</div>

<div class="filter-container">
    <label for="methodFilter">Filter by Main Method:</label>
    <select id="methodFilter" onchange="filterTable()">
        <option value="">All</option>
        <!-- Options will be dynamically populated -->
    </select>
    
    <label for="areaFilter" style="margin-left: 20px;">Filter by Research Area:</label>
    <select id="areaFilter" onchange="filterTable()">
        <option value="">All</option>
        <!-- Add more options as needed -->
    </select>

    <button class="clear-filters" onclick="clearFilters()">No filters selected</button>
</div>

<div class="filter-notice" id="filterNotice" style="display: none;">
    You are currently filtering the results.
</div>

<table id="abstractTable">
    <thead>
        <tr>
            <th><div>Abstract<br>ID</div></th>
            <th><div>Main<br>Method</div></th>
            <th><div>Preliminary<br>Title & Abstract</div></th>
            <th><div>Research<br>Area 1</div></th>
            <th><div>Research<br>Area 2</div></th>
            <th><div>Research<br>Area 3</div></th>
        </tr>
    </thead>
    <tbody>
        <!-- Rows will be populated here by JavaScript -->
    </tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    let allRows = [];

    document.addEventListener("DOMContentLoaded", function() {
        fetch("Prelim_Hons_Thesis_Titles_and_Abstracts_2024_FinalX.xlsx")
            .then(response => response.arrayBuffer())
            .then(data => {
                const workbook = XLSX.read(data, {type: "array"});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                allRows = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                allRows = allRows.slice(1); // Remove header row
                populateTable(allRows);
                populateFilterOptions(allRows);
                updateClearFiltersButton(); // Ensure correct button state on load
            })
            .catch(error => console.error('Error loading XLSX data:', error));
    });

    function populateTable(rows) {
        const tbody = document.querySelector("#abstractTable tbody");
        tbody.innerHTML = ""; // Clear previous rows

        rows.forEach(row => {
            if (row.length < 8) {
                console.warn("Skipping row due to missing columns:", row);
                return;
            }

            const tr = document.createElement("tr");

            const abstractID = row[0] ? row[0].trim() : ''; // Abstract ID
            let mainMethod = row[1] ? row[1].trim() : ''; // Main Method
            const methodDetail = row[2] ? row[2].trim() : ''; // Method Detail
            const preliminaryTitle = row[3] ? row[3].trim() : ''; // Preliminary Title
            const preliminaryAbstract = row[4] ? row[4].trim() : ''; // Preliminary Abstract
            const researchArea1 = row[5] ? row[5].trim() : ''; // Research Area 1
            const researchArea2 = row[6] ? row[6].trim() : ''; // Research Area 2
            const researchArea3 = row[7] ? row[7].trim() : ''; // Research Area 3

            if (methodDetail) {
                mainMethod += ` (${methodDetail})`;
            }

            const titleAndAbstract = `<strong>${preliminaryTitle}</strong><br>${preliminaryAbstract}`;

            tr.innerHTML = `
                <td>${abstractID}</td>
                <td>${mainMethod}</td>
                <td>${titleAndAbstract}</td>
                <td>${researchArea1}</td>
                <td>${researchArea2}</td>
                <td>${researchArea3}</td>
            `;

            tbody.appendChild(tr);
        });
    }

    function populateFilterOptions(rows) {
        const methodFilter = document.getElementById("methodFilter");
        const areaFilter = document.getElementById("areaFilter");
        const methodCounts = {};
        const areaCounts = {};

        rows.forEach(row => {
            const mainMethod = row[1] ? row[1].trim() : '';
            const researchAreas = [row[5] ? row[5].trim() : '', row[6] ? row[6].trim() : '', row[7] ? row[7].trim() : ''];

            if (mainMethod) {
                if (methodCounts[mainMethod]) {
                    methodCounts[mainMethod]++;
                } else {
                    methodCounts[mainMethod] = 1;
                }
            }

            researchAreas.forEach(area => {
                if (area) {
                    if (areaCounts[area]) {
                        areaCounts[area]++;
                    } else {
                        areaCounts[area] = 1;
                    }
                }
            });
        });

        for (const method in methodCounts) {
            const option = document.createElement("option");
            option.value = method;
            option.textContent = `${method} [${methodCounts[method]} matches]`;
            methodFilter.appendChild(option);
        }

        for (const area in areaCounts) {
            const option = document.createElement("option");
            option.value = area;
            option.textContent = `${area} [${areaCounts[area]} matches]`;
            areaFilter.appendChild(option);
        }
    }

    function filterTable() {
        const searchInput = document.getElementById("searchInput").value.toLowerCase();
        const methodFilter = document.getElementById("methodFilter").value.toLowerCase();
        const areaFilter = document.getElementById("areaFilter").value.toLowerCase();
        const filterNotice = document.getElementById("filterNotice");
        const clearFiltersButton = document.querySelector(".clear-filters");
        let filteredRows = allRows;

        if (searchInput || methodFilter || areaFilter) {
            filterNotice.style.display = "block";
            filteredRows = allRows.filter(row => {
                const abstractText = row[4].trim().toLowerCase();
                const mainMethod = row[1].trim().toLowerCase();
                const researchAreas = [row[5] ? row[5].trim().toLowerCase() : '', row[6] ? row[6].trim().toLowerCase() : '', row[7] ? row[7].trim().toLowerCase() : ''];

                const matchesSearch = abstractText.includes(searchInput);
                const matchesMethod = !methodFilter || mainMethod === methodFilter;
                const matchesArea = !areaFilter || researchAreas.includes(areaFilter);

                return matchesSearch && matchesMethod && matchesArea;
            });

            clearFiltersButton.textContent = "Clear filters";
            clearFiltersButton.classList.add("active");
        } else {
            filterNotice.style.display = "none";
            clearFiltersButton.textContent = "No filters selected";
            clearFiltersButton.classList.remove("active");
        }

        updateClearFiltersButton(); // Update button style and text based on filters
        populateTable(filteredRows);
    }

    function clearFilters() {
        document.getElementById("searchInput").value = ""; // Clear the search input
        document.getElementById("methodFilter").selectedIndex = 0; // Reset the method filter
        document.getElementById("areaFilter").selectedIndex = 0; // Reset the area filter
        filterTable(); // Trigger table filtering to reset the view
    }

    function updateClearFiltersButton() {
        const clearFiltersButton = document.querySelector(".clear-filters");
        const searchInput = document.getElementById("searchInput").value;
        const methodFilter = document.getElementById("methodFilter").value;
        const areaFilter = document.getElementById("areaFilter").value;

        if (searchInput || methodFilter || areaFilter) {
            clearFiltersButton.textContent = "Clear filters";
            clearFiltersButton.classList.add("active");
            clearFiltersButton.style.backgroundColor = "#007bff"; // Blue when filters are active
        } else {
            clearFiltersButton.textContent = "No filters selected";
            clearFiltersButton.classList.remove("active");
            clearFiltersButton.style.backgroundColor = "#28a745"; // Green when no filters
        }
    }
</script>

</body>
</html>