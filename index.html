<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Searchable and Filterable Table</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <style>
        body { font-family: Arial, sans-serif; font-size: 14px; }
        .dataTables_wrapper .dataTables_filter input { width: 100%; font-size: 14px; padding: 10px; border-radius: 4px; margin-left: 0; }
        .dataTables_wrapper .dataTables_filter { float: left; text-align: left; }
        .dataTables_wrapper .dataTables_length { float: right; }
        .clear-filters { cursor: pointer; background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; transition: background-color 0.3s, color 0.3s; }
        .clear-filters.active { background-color: red; }
        .filter-notice { margin: 10px 0; font-style: italic; color: #555; }
    </style>
</head>
<body>

<div class="filter-container">
    <label for="methodFilter">Filter by Main Method:</label>
    <select id="methodFilter" onchange="filterTable()"><option value="">All</option></select>
    <label for="areaFilter" style="margin-left: 20px;">Filter by Research Area:</label>
    <select id="areaFilter" onchange="filterTable()"><option value="">All</option></select>
    <button class="clear-filters" onclick="clearFilters()">No filters selected</button>
</div>

<div class="filter-notice" id="filterNotice" style="display: none;"></div>

<table id="abstractTable" class="display">
    <thead>
        <tr><th>Abstract Details</th><th>Preliminary Title and Abstract</th></tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    let allRows = [];

    document.addEventListener("DOMContentLoaded", () => {
        fetch("Prelim_Hons_Thesis_Titles_and_Abstracts_2024_FinalX.xlsx")
            .then(res => res.arrayBuffer())
            .then(data => {
                const sheet = XLSX.read(data, {type: "array"}).Sheets[XLSX.read(data, {type: "array"}).SheetNames[0]];
                allRows = XLSX.utils.sheet_to_json(sheet, {header: 1}).slice(1);
                populateTable(allRows);
                populateFilterOptions(allRows);
                $('#abstractTable').DataTable({ // Initialize DataTables
                    paging: true,
                    searching: false, // Disable default DataTables search
                    info: false,
                    autoWidth: false
                });
            })
            .catch(err => console.error('Error loading XLSX data:', err));
    });

    function populateTable(rows) {
        const tbody = document.querySelector("#abstractTable tbody");
        tbody.innerHTML = rows.map(row => {
            const [abstractID, mainMethod = '', methodDetail = '', preliminaryTitle = '', preliminaryAbstract = '', ...researchAreas] = row;
            const abstractDetails = `<strong>Abstract ID:</strong> #${abstractID || ''}<br><br><strong>Method:</strong> ${mainMethod}${methodDetail ? `<br>(${methodDetail})` : ''}<br><br><strong>Research Areas:</strong> ${researchAreas.filter(Boolean).join('; ')}`;
            return `<tr><td>${abstractDetails}</td><td><strong>${preliminaryTitle}</strong><br>${preliminaryAbstract}</td></tr>`;
        }).join('');
    }

    function populateFilterOptions(rows) {
        const methodCounts = {}, areaCounts = {};
        rows.forEach(row => {
            const [_, mainMethod = '', , , , ...researchAreas] = row;
            methodCounts[mainMethod] = (methodCounts[mainMethod] || 0) + 1;
            researchAreas.forEach(area => area && (areaCounts[area] = (areaCounts[area] || 0) + 1));
        });
        document.getElementById("methodFilter").innerHTML += generateOptions(methodCounts, (a, b) => b[1] - a[1]);
        document.getElementById("areaFilter").innerHTML += generateOptions(areaCounts, ([a], [b]) => a.localeCompare(b));
    }

    function generateOptions(counts, sortFn) {
        return Object.entries(counts).sort(sortFn).map(([key, count]) => `<option value="${key}">${key} [${count} matches]</option>`).join('');
    }

    function filterTable() {
        const searchInput = document.getElementById("searchInput").value.toLowerCase();
        const methodFilter = document.getElementById("methodFilter").value.toLowerCase();
        const areaFilter = document.getElementById("areaFilter").value.toLowerCase();
        const filteredRows = allRows.filter(row => {
            const abstractText = row[4]?.toLowerCase() || '';
            const mainMethod = row[1]?.toLowerCase() || '';
            const researchAreas = row.slice(5, 11).map(area => area?.toLowerCase() || '');
            return abstractText.includes(searchInput) && (!methodFilter || mainMethod === methodFilter) && (!areaFilter || researchAreas.includes(areaFilter));
        });

        document.querySelector("#filterNotice").style.display = filteredRows.length < allRows.length ? "block" : "none";
        document.querySelector(".clear-filters").classList.toggle("active", filteredRows.length < allRows.length);
        document.querySelector(".clear-filters").textContent = filteredRows.length < allRows.length ? "Clear filters" : "No filters selected";

        // Destroy the current DataTable before populating the new data
        $('#abstractTable').DataTable().clear().destroy();

        // Populate the table with filtered rows and reinitialize DataTables
        populateTable(filteredRows);
        $('#abstractTable').DataTable({
            paging: true,
            searching: false,
            info: false,
            autoWidth: false
        });
    }

    function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("methodFilter").selectedIndex = 0;
        document.getElementById("areaFilter").selectedIndex = 0;
        filterTable();
    }
</script>

</body>
</html>